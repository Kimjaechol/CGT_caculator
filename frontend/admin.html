<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>ê´€ë¦¬ì - ì–‘ë„ì†Œë“ì„¸ AI í”Œë«í¼</title>

    <script src="./env.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .tab-btn { padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; }
        .tab-btn.active { background: #3b82f6; color: white; }
        .tab-btn:not(.active) { background: #f1f5f9; color: #64748b; }
        .tab-btn:not(.active):hover { background: #e2e8f0; }

        .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; font-weight: 600; }
        .card-body { padding: 1.5rem; }

        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }

        .input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; }
        .input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem; color: #64748b; border-bottom: 1px solid #e5e7eb; }
        td { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; }
        tr:hover td { background: #f8fafc; }

        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }

        .upload-zone { border: 2px dashed #d1d5db; border-radius: 0.75rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-zone:hover { border-color: #3b82f6; background: #f8fafc; }
        .upload-zone.dragover { border-color: #3b82f6; background: #eff6ff; }

        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 1000; animation: slideIn 0.3s ease-out; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center">
        <div class="card w-full max-w-md">
            <div class="card-header text-center">
                <h1 class="text-xl font-bold text-gray-800">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
                <p class="text-sm text-gray-500 mt-1">ì–‘ë„ì†Œë“ì„¸ AI í”Œë«í¼</p>
            </div>
            <div class="card-body">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì•„ì´ë””</label>
                        <input type="text" id="loginUsername" class="input" placeholder="admin" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" class="input" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full py-3">ë¡œê·¸ì¸</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">
                        A
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                        <p class="text-xs text-gray-500">ì–‘ë„ì†Œë“ì„¸ AI í”Œë«í¼</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="./" class="text-sm text-gray-500 hover:text-gray-700">ë©”ì¸ ì‚¬ì´íŠ¸</a>
                    <button onclick="adminLogout()" class="btn text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="switchAdminTab('knowledge')" class="tab-btn active" data-tab="knowledge">ì§€ì‹ DB ê´€ë¦¬</button>
                <button onclick="switchAdminTab('gemini')" class="tab-btn" data-tab="gemini">Gemini File Search</button>
                <button onclick="switchAdminTab('users')" class="tab-btn" data-tab="users">íšŒì› ê´€ë¦¬</button>
                <button onclick="switchAdminTab('consultations')" class="tab-btn" data-tab="consultations">AI ìƒë‹´ ë‚´ì—­</button>
                <button onclick="switchAdminTab('meeting-requests')" class="tab-btn" data-tab="meeting-requests">ëŒ€ë©´ìƒë‹´ ì‹ ì²­</button>
                <button onclick="switchAdminTab('uploads')" class="tab-btn" data-tab="uploads">ì—…ë¡œë“œ ê¸°ë¡</button>
            </div>

            <!-- ì§€ì‹ DB ê´€ë¦¬ íƒ­ -->
            <div id="tab-knowledge" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- ì§€ì‹ ì¶”ê°€ -->
                    <div class="card">
                        <div class="card-header">ì§€ì‹ í•­ëª© ì¶”ê°€</div>
                        <div class="card-body">
                            <form id="addKnowledgeForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¹´í…Œê³ ë¦¬</label>
                                    <select id="knowledgeCategory" class="input">
                                        <option value="ë¹„ê³¼ì„¸">ë¹„ê³¼ì„¸</option>
                                        <option value="ê³µì œ">ê³µì œ</option>
                                        <option value="ì„¸ìœ¨">ì„¸ìœ¨</option>
                                        <option value="ê°ë©´">ê°ë©´</option>
                                        <option value="ì¼ë°˜">ì¼ë°˜</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
                                    <input type="text" id="knowledgeTitle" class="input" placeholder="ì˜ˆ: 1ì„¸ëŒ€1ì£¼íƒ ë¹„ê³¼ì„¸" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‚´ìš©</label>
                                    <textarea id="knowledgeContent" class="input h-32" placeholder="ì„¸ë¬´ ì§€ì‹ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">í‚¤ì›Œë“œ (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)</label>
                                    <input type="text" id="knowledgeKeywords" class="input" placeholder="1ì„¸ëŒ€1ì£¼íƒ ë¹„ê³¼ì„¸ 12ì–µ">
                                </div>
                                <button type="submit" class="btn btn-primary w-full">ì¶”ê°€í•˜ê¸°</button>
                            </form>
                        </div>
                    </div>

                    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                    <div class="card">
                        <div class="card-header">í…ìŠ¤íŠ¸/ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ì—…ë¡œë“œ (FTS5)</div>
                        <div class="card-body">
                            <p class="text-sm text-gray-500 mb-4">
                                .txt, .md íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë‚´ìš©ì´ FTS5 í‚¤ì›Œë“œ ê²€ìƒ‰ DBì— ì €ì¥ë©ë‹ˆë‹¤.
                                íŒŒì¼ëª…ì—ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤ (ì˜ˆ: ë¹„ê³¼ì„¸_ì¼ì‹œì 2ì£¼íƒ.md â†’ ì¹´í…Œê³ ë¦¬: ë¹„ê³¼ì„¸)
                            </p>
                            <div id="fts5UploadZone" class="upload-zone" onclick="document.getElementById('fts5FileInput').click()">
                                <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="text-gray-600">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
                                <p class="text-xs text-gray-400 mt-1">.txt, .md íŒŒì¼ (UTF-8)</p>
                            </div>
                            <input type="file" id="fts5FileInput" accept=".txt,.md" multiple class="hidden" onchange="uploadFTS5Files(this.files)">
                            <div id="fts5UploadStatus" class="mt-4 hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- ì§€ì‹ ëª©ë¡ -->
                <div class="card mt-6">
                    <div class="card-header flex flex-wrap items-center justify-between gap-2">
                        <span>ì§€ì‹ ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡</span>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="reExtractSelectedKeywords()" id="reExtractSelectedBtn" class="btn text-sm bg-purple-500 text-white hover:bg-purple-600 hidden">
                                ì„ íƒ í•­ëª© í‚¤ì›Œë“œ ì¬ì¶”ì¶œ
                            </button>
                            <button onclick="reExtractAllKeywords()" class="btn text-sm bg-purple-100 text-purple-700 hover:bg-purple-200">
                                ì „ì²´ í‚¤ì›Œë“œ ì¬ì¶”ì¶œ
                            </button>
                            <button onclick="loadKnowledge()" class="btn text-sm bg-gray-100 text-gray-700">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th class="w-10"><input type="checkbox" id="selectAllKnowledge" onchange="toggleSelectAll(this)" class="rounded"></th>
                                    <th>ID</th>
                                    <th>ì¹´í…Œê³ ë¦¬</th>
                                    <th>ì œëª©</th>
                                    <th>ë‚´ìš©</th>
                                    <th>í‚¤ì›Œë“œ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="knowledgeTableBody">
                                <tr><td colspan="7" class="text-center text-gray-400 py-8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

    <!-- ì§€ì‹ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="editKnowledgeModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">ì§€ì‹ í•­ëª© í¸ì§‘</h3>
                <button onclick="hideEditModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <form id="editKnowledgeForm" class="space-y-4">
                <input type="hidden" id="editKnowledgeId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¹´í…Œê³ ë¦¬</label>
                    <select id="editKnowledgeCategory" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="ë¹„ê³¼ì„¸">ë¹„ê³¼ì„¸</option>
                        <option value="ì„¸ìœ¨">ì„¸ìœ¨</option>
                        <option value="ê³µì œ">ê³µì œ</option>
                        <option value="ê°ë©´">ê°ë©´</option>
                        <option value="ì‹ ê³ ">ì‹ ê³ </option>
                        <option value="2025">2025</option>
                        <option value="ì¼ë°˜">ì¼ë°˜</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
                    <input type="text" id="editKnowledgeTitle" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‚´ìš©</label>
                    <textarea id="editKnowledgeContent" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 h-48" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">í‚¤ì›Œë“œ (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="editKnowledgeKeywords" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">ì €ì¥</button>
                    <button type="button" onclick="hideEditModal()" class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

            <!-- Gemini File Search íƒ­ -->
            <div id="tab-gemini" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <div class="card-header">Gemini File Search Store ì—…ë¡œë“œ</div>
                        <div class="card-body">
                            <p class="text-sm text-gray-500 mb-4">
                                PDF, HWP, ë¬¸ì„œ íŒŒì¼ ë“±ì„ Gemini File Search Storeì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.
                                Google AIê°€ ìë™ìœ¼ë¡œ íŒŒì¼ì„ íŒŒì‹±í•˜ê³  ì¸ë±ì‹±í•©ë‹ˆë‹¤. (ìµœëŒ€ 100MB)
                            </p>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Store ì´ë¦„</label>
                                <input type="text" id="geminiStoreName" class="input" value="Lawith_Tax_Store" placeholder="Store ì´ë¦„">
                            </div>
                            <div id="geminiUploadZone" class="upload-zone" onclick="document.getElementById('geminiFileInput').click()">
                                <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="text-gray-600">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
                                <p class="text-xs text-gray-400 mt-1">PDF, HWP, ë¬¸ì„œ íŒŒì¼ ë“± (ìµœëŒ€ 100MB)</p>
                            </div>
                            <input type="file" id="geminiFileInput" multiple class="hidden" onchange="uploadGeminiFiles(this.files)">
                            <div id="geminiUploadStatus" class="mt-4 hidden"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">File Search Stores</div>
                        <div class="card-body">
                            <div id="geminiStoresList" class="space-y-3">
                                <p class="text-gray-400 text-sm">Store ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RAG í…ŒìŠ¤íŠ¸ ì„¹ì…˜ (3ë‹¨ê³„ íŒŒì´í”„ë¼ì¸) -->
                <div class="card mt-6">
                    <div class="card-header flex items-center justify-between">
                        <span>3ë‹¨ê³„ RAG íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸</span>
                        <button onclick="loadRagStatus()" class="btn text-sm bg-gray-100 text-gray-700">ìƒíƒœ í™•ì¸</button>
                    </div>
                    <div class="card-body">
                        <div id="ragStatusPanel" class="mb-4 p-3 bg-gray-50 rounded-lg hidden">
                            <h4 class="font-medium text-gray-700 mb-2">RAG ì‹œìŠ¤í…œ ìƒíƒœ</h4>
                            <div id="ragStatusContent" class="text-sm"></div>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">
                            <strong>3ë‹¨ê³„ RAG í”„ë¡œì„¸ìŠ¤:</strong><br>
                            1ë‹¨ê³„: AIê°€ ì§ˆë¬¸ ë¶„ì„ â†’ ì˜ë„ íŒŒì•…, ìŸì  í™•ì •, í‚¤ì›Œë“œ í™•ì¥<br>
                            2ë‹¨ê³„: í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ â†’ FTS5 í‚¤ì›Œë“œê²€ìƒ‰ + Gemini ì‹œë©˜í‹±ê²€ìƒ‰<br>
                            3ë‹¨ê³„: ê²°ê³¼ í†µí•© â†’ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì¡°í•©í•˜ì—¬ ë‹µë³€ ìƒì„±
                        </p>
                        <form id="ragTestForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">í…ŒìŠ¤íŠ¸ ì§ˆë¬¸</label>
                                <input type="text" id="ragTestQuery" class="input" placeholder="ì˜ˆ: 1ì„¸ëŒ€ 1ì£¼íƒ ë¹„ê³¼ì„¸ ìš”ê±´ì´ ê¶ê¸ˆí•©ë‹ˆë‹¤" required>
                            </div>
                            <button type="submit" class="btn btn-primary">3ë‹¨ê³„ RAG í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                        </form>
                        <div id="ragTestResults" class="mt-4 hidden">
                            <div class="space-y-4">
                                <!-- 1ë‹¨ê³„: ì§ˆë¬¸ ë¶„ì„ ê²°ê³¼ -->
                                <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <h4 class="font-medium text-yellow-700 mb-2">ğŸ“ 1ë‹¨ê³„: ì§ˆë¬¸ ë¶„ì„ ê²°ê³¼</h4>
                                    <div id="ragAnalysisResult" class="text-sm text-gray-700"></div>
                                </div>
                                <!-- 2ë‹¨ê³„: FTS5 í‚¤ì›Œë“œ ê²€ìƒ‰ -->
                                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <h4 class="font-medium text-blue-700 mb-2">ğŸ” 2ë‹¨ê³„-A: FTS5 í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼</h4>
                                    <pre id="ragFts5Result" class="text-sm whitespace-pre-wrap text-gray-700"></pre>
                                </div>
                                <!-- 2ë‹¨ê³„: Gemini ì‹œë©˜í‹± ê²€ìƒ‰ -->
                                <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                                    <h4 class="font-medium text-purple-700 mb-2">ğŸ§  2ë‹¨ê³„-B: Gemini ì‹œë©˜í‹± ê²€ìƒ‰ ê²°ê³¼</h4>
                                    <pre id="ragGeminiResult" class="text-sm whitespace-pre-wrap text-gray-700"></pre>
                                </div>
                                <!-- 3ë‹¨ê³„: í†µí•© ê²°ê³¼ -->
                                <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                                    <h4 class="font-medium text-green-700 mb-2">âœ… 3ë‹¨ê³„: í†µí•© ê²€ìƒ‰ ê²°ê³¼</h4>
                                    <pre id="ragCombinedResult" class="text-sm whitespace-pre-wrap text-gray-700"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íšŒì› ê´€ë¦¬ íƒ­ -->
            <div id="tab-users" class="tab-content hidden">
                <div class="card">
                    <div class="card-header flex items-center justify-between">
                        <span>íšŒì› ëª©ë¡</span>
                        <button onclick="loadUsers()" class="btn text-sm bg-gray-100 text-gray-700">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>í”„ë¡œí•„</th>
                                    <th>ì´ë¦„</th>
                                    <th>ë‹‰ë„¤ì„</th>
                                    <th>ìƒë…„ì›”ì¼</th>
                                    <th>ì„±ë³„</th>
                                    <th>ì´ë©”ì¼</th>
                                    <th>íœ´ëŒ€í°</th>
                                    <th>ê°€ì…ì¼</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="9" class="text-center text-gray-400 py-8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ìƒë‹´ ë‚´ì—­ íƒ­ -->
            <div id="tab-consultations" class="tab-content hidden">
                <div class="card">
                    <div class="card-header flex items-center justify-between">
                        <span>ìƒë‹´ ë‚´ì—­</span>
                        <button onclick="loadConsultations()" class="btn text-sm bg-gray-100 text-gray-700">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ì‚¬ìš©ì</th>
                                    <th>ì§ˆë¬¸</th>
                                    <th>ìƒë‹´ì¼ì‹œ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="consultationsTableBody">
                                <tr><td colspan="5" class="text-center text-gray-400 py-8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ëŒ€ë©´ìƒë‹´ ì‹ ì²­ íƒ­ -->
            <div id="tab-meeting-requests" class="tab-content hidden">
                <div class="card">
                    <div class="card-header flex items-center justify-between">
                        <span>ëŒ€ë©´ìƒë‹´ ì‹ ì²­ ëª©ë¡</span>
                        <div class="flex items-center space-x-2">
                            <select id="meetingStatusFilter" class="input text-sm py-1 w-32" onchange="loadMeetingRequests()">
                                <option value="">ì „ì²´</option>
                                <option value="pending">ëŒ€ê¸°ì¤‘</option>
                                <option value="confirmed">í™•ì •</option>
                                <option value="completed">ì™„ë£Œ</option>
                                <option value="cancelled">ì·¨ì†Œ</option>
                            </select>
                            <button onclick="loadMeetingRequests()" class="btn text-sm bg-gray-100 text-gray-700">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ìœ í˜•</th>
                                    <th>ì‹ ì²­ì</th>
                                    <th>ì—°ë½ì²˜</th>
                                    <th>í¬ë§ì¼</th>
                                    <th>ìƒë‹´ë‚´ìš©</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì•Œë¦¼</th>
                                    <th>ì‹ ì²­ì¼</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="meetingRequestsTableBody">
                                <tr><td colspan="10" class="text-center text-gray-400 py-8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ê¸°ë¡ íƒ­ -->
            <div id="tab-uploads" class="tab-content hidden">
                <div class="card">
                    <div class="card-header flex items-center justify-between">
                        <span>ì—…ë¡œë“œëœ íŒŒì¼ ê¸°ë¡</span>
                        <button onclick="loadUploads()" class="btn text-sm bg-gray-100 text-gray-700">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>íŒŒì¼ëª…</th>
                                    <th>íƒ€ì…</th>
                                    <th>ëŒ€ìƒ</th>
                                    <th>Store</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì—…ë¡œë“œì¼ì‹œ</th>
                                </tr>
                            </thead>
                            <tbody id="uploadsTableBody">
                                <tr><td colspan="7" class="text-center text-gray-400 py-8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ìƒë‹´ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="consultationModal" class="modal-backdrop hidden" onclick="if(event.target === this) closeConsultationModal()">
        <div class="modal-content">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="font-bold text-gray-800">ìƒë‹´ ìƒì„¸</h3>
                <button onclick="closeConsultationModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto" id="consultationModalContent">
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.ENV_API_URL || 'https://cgtcaculator-production.up.railway.app';
        let adminToken = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', () => {
            adminToken = localStorage.getItem('adminToken');
            if (adminToken) {
                showDashboard();
                loadAllData();
            }
        });

        // ë¡œê·¸ì¸
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const res = await fetch(`${API_BASE_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    showDashboard();
                    loadAllData();
                } else {
                    showToast(data.detail || 'ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showToast('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        });

        function adminLogout() {
            adminToken = null;
            localStorage.removeItem('adminToken');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        // íƒ­ë³„ ë°ì´í„° ë¡œë“œ ìƒíƒœ ì¶”ì 
        const tabDataLoaded = {
            knowledge: false,
            gemini: false,
            users: false,
            consultations: false,
            'meeting-requests': false,
            uploads: false
        };

        function loadAllData() {
            // í˜„ì¬ í™œì„± íƒ­ì˜ ë°ì´í„°ë§Œ ë¡œë“œ (ê¸°ë³¸: knowledge)
            loadKnowledge();
            tabDataLoaded.knowledge = true;
        }

        // íƒ­ ì „í™˜ (í•„ìš”ì‹œ ë°ì´í„° ë¡œë“œ)
        function switchAdminTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            // í•´ë‹¹ íƒ­ ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œë“œ
            if (!tabDataLoaded[tab]) {
                tabDataLoaded[tab] = true;
                switch(tab) {
                    case 'knowledge': loadKnowledge(); break;
                    case 'gemini': loadGeminiStores(); break;
                    case 'users': loadUsers(); break;
                    case 'consultations': loadConsultations(); break;
                    case 'meeting-requests': loadMeetingRequests(); break;
                    case 'uploads': loadUploads(); break;
                }
            }
        }

        // API ìš”ì²­ í—¬í¼ (íƒ€ì„ì•„ì›ƒ í¬í•¨)
        async function adminFetch(url, options = {}, timeout = 10000) {
            const headers = { ...options.headers, 'Authorization': `Bearer ${adminToken}` };

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const res = await fetch(url, { ...options, headers, signal: controller.signal });
                clearTimeout(timeoutId);

                if (res.status === 401 || res.status === 403) {
                    adminLogout();
                    showToast('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    throw new Error('Unauthorized');
                }
                return res;
            } catch (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                    throw new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼');
                }
                throw err;
            }
        }

        // ì§€ì‹ DB ê´€ë¦¬
        async function loadKnowledge() {
            const tbody = document.getElementById('knowledgeTableBody');
            // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
            document.getElementById('selectAllKnowledge').checked = false;
            updateSelectedCount();

            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/knowledge`);
                const data = await res.json();
                if (data.entries && data.entries.length > 0) {
                    tbody.innerHTML = data.entries.map(e => `
                        <tr>
                            <td><input type="checkbox" class="knowledge-checkbox rounded" value="${e.id}" onchange="updateSelectedCount()"></td>
                            <td>${e.id}</td>
                            <td><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${e.category}</span></td>
                            <td class="font-medium">${e.title}</td>
                            <td class="max-w-xs truncate" title="${e.content}">${e.content.substring(0, 100)}...</td>
                            <td class="text-gray-500 text-xs max-w-xs truncate" title="${e.keywords}">${e.keywords || '-'}</td>
                            <td class="whitespace-nowrap">
                                <button onclick="reExtractSingleKeyword(${e.id})" class="text-purple-500 hover:text-purple-700 text-sm mr-1" title="í‚¤ì›Œë“œ ì¬ì¶”ì¶œ">ğŸ”„</button>
                                <button onclick="showEditModal(${e.id})" class="text-blue-500 hover:text-blue-700 text-sm mr-1">í¸ì§‘</button>
                                <button onclick="deleteKnowledge(${e.id})" class="text-red-500 hover:text-red-700 text-sm">ì‚­ì œ</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-400 py-8">ë“±ë¡ëœ ì§€ì‹ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-red-400 py-8">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</td></tr>`;
            }
        }

        document.getElementById('addKnowledgeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const entry = {
                category: document.getElementById('knowledgeCategory').value,
                title: document.getElementById('knowledgeTitle').value,
                content: document.getElementById('knowledgeContent').value,
                keywords: document.getElementById('knowledgeKeywords').value
            };

            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/knowledge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('ì§€ì‹ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    e.target.reset();
                    loadKnowledge();
                }
            } catch (err) {
                showToast('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        });

        async function deleteKnowledge(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await adminFetch(`${API_BASE_URL}/api/admin/knowledge/${id}`, { method: 'DELETE' });
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                loadKnowledge();
            } catch (err) {
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // í‚¤ì›Œë“œ ì¬ì¶”ì¶œ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.knowledge-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.knowledge-checkbox:checked');
            const btn = document.getElementById('reExtractSelectedBtn');
            if (checkboxes.length > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `ì„ íƒ í•­ëª© í‚¤ì›Œë“œ ì¬ì¶”ì¶œ (${checkboxes.length}ê°œ)`;
            } else {
                btn.classList.add('hidden');
            }
        }

        function getSelectedIds() {
            const checkboxes = document.querySelectorAll('.knowledge-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function reExtractSingleKeyword(id) {
            if (!confirm('ì´ í•­ëª©ì˜ í‚¤ì›Œë“œë¥¼ AIë¡œ ì¬ì¶”ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showToast('í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘...', 'success');

            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/knowledge/${id}/re-extract-keywords`, {
                    method: 'POST'
                }, 30000);
                const data = await res.json();

                if (data.status === 'success') {
                    showToast(`í‚¤ì›Œë“œ ${data.keyword_count}ê°œ ì¶”ì¶œ ì™„ë£Œ`, 'success');
                    loadKnowledge();
                } else {
                    showToast(data.message || 'í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showToast(`í‚¤ì›Œë“œ ì¶”ì¶œ ì˜¤ë¥˜: ${err.message}`, 'error');
            }
        }

        async function reExtractSelectedKeywords() {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                showToast('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            if (!confirm(`ì„ íƒí•œ ${ids.length}ê°œ í•­ëª©ì˜ í‚¤ì›Œë“œë¥¼ AIë¡œ ì¬ì¶”ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`)) return;

            const btn = document.getElementById('reExtractSelectedBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ì¶”ì¶œ ì¤‘...';

            try {
                const formData = new FormData();
                formData.append('entry_ids', ids.join(','));

                const res = await adminFetch(`${API_BASE_URL}/api/admin/knowledge/re-extract-keywords-bulk`, {
                    method: 'POST',
                    body: formData
                }, 120000); // 2ë¶„ íƒ€ì„ì•„ì›ƒ

                const data = await res.json();

                if (data.status === 'success') {
                    showToast(`${data.success_count}ê°œ ì„±ê³µ, ${data.error_count}ê°œ ì‹¤íŒ¨`, 'success');
                    loadKnowledge();
                } else {
                    showToast(data.message || 'í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showToast(`í‚¤ì›Œë“œ ì¶”ì¶œ ì˜¤ë¥˜: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function reExtractAllKeywords() {
            if (!confirm('ëª¨ë“  í•­ëª©ì˜ í‚¤ì›Œë“œë¥¼ AIë¡œ ì¬ì¶”ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nâš ï¸ í•­ëª© ìˆ˜ì— ë”°ë¼ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;

            const btn = document.querySelector('button[onclick="reExtractAllKeywords()"]');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ì „ì²´ ì¶”ì¶œ ì¤‘...';

            try {
                const formData = new FormData();
                formData.append('entry_ids', 'all');

                const res = await adminFetch(`${API_BASE_URL}/api/admin/knowledge/re-extract-keywords-bulk`, {
                    method: 'POST',
                    body: formData
                }, 300000); // 5ë¶„ íƒ€ì„ì•„ì›ƒ

                const data = await res.json();

                if (data.status === 'success') {
                    showToast(`ì „ì²´ í‚¤ì›Œë“œ ì¬ì¶”ì¶œ ì™„ë£Œ: ${data.success_count}ê°œ ì„±ê³µ, ${data.error_count}ê°œ ì‹¤íŒ¨`, 'success');
                    loadKnowledge();
                } else {
                    showToast(data.message || 'í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showToast(`í‚¤ì›Œë“œ ì¶”ì¶œ ì˜¤ë¥˜: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ì§€ì‹ í¸ì§‘ ëª¨ë‹¬ í•¨ìˆ˜ë“¤
        async function showEditModal(id) {
            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/knowledge/${id}`);
                const data = await res.json();
                if (data.entry) {
                    document.getElementById('editKnowledgeId').value = data.entry.id;
                    document.getElementById('editKnowledgeCategory').value = data.entry.category || 'ì¼ë°˜';
                    document.getElementById('editKnowledgeTitle').value = data.entry.title || '';
                    document.getElementById('editKnowledgeContent').value = data.entry.content || '';
                    document.getElementById('editKnowledgeKeywords').value = data.entry.keywords || '';
                    document.getElementById('editKnowledgeModal').classList.remove('hidden');
                } else {
                    showToast('ì§€ì‹ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
            } catch (err) {
                showToast('ì§€ì‹ í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function hideEditModal() {
            document.getElementById('editKnowledgeModal').classList.add('hidden');
        }

        // í¸ì§‘ í¼ ì œì¶œ í•¸ë“¤ëŸ¬
        document.getElementById('editKnowledgeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editKnowledgeId').value;
            const formData = new FormData();
            formData.append('category', document.getElementById('editKnowledgeCategory').value);
            formData.append('title', document.getElementById('editKnowledgeTitle').value);
            formData.append('content', document.getElementById('editKnowledgeContent').value);
            formData.append('keywords', document.getElementById('editKnowledgeKeywords').value);

            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/knowledge/${id}`, {
                    method: 'PUT',
                    body: formData
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('ì§€ì‹ í•­ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    hideEditModal();
                    loadKnowledge();
                } else {
                    showToast(data.detail || 'ìˆ˜ì • ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showToast('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        });

        // FTS5 íŒŒì¼ ì—…ë¡œë“œ (AI í‚¤ì›Œë“œ ìë™ ì¶”ì¶œ)
        async function uploadFTS5Files(files) {
            const statusDiv = document.getElementById('fts5UploadStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="flex items-center text-blue-600"><div class="spinner mr-2"></div>ì—…ë¡œë“œ ë° AI í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘...</div>';

            const uploadResults = [];

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await adminFetch(`${API_BASE_URL}/api/admin/knowledge/upload`, {
                        method: 'POST',
                        body: formData
                    }, 30000); // AI ì¶”ì¶œ ì‹œê°„ì„ ìœ„í•´ 30ì´ˆ íƒ€ì„ì•„ì›ƒ
                    const data = await res.json();
                    if (data.status === 'success') {
                        uploadResults.push({
                            filename: file.name,
                            entry_id: data.entry_id,
                            keywords: data.extracted_keywords,
                            keyword_count: data.keyword_count
                        });
                        showToast(`${file.name} ì—…ë¡œë“œ ì™„ë£Œ (í‚¤ì›Œë“œ ${data.keyword_count}ê°œ ì¶”ì¶œ)`, 'success');
                    } else {
                        showToast(`${file.name}: ${data.message}`, 'error');
                    }
                } catch (err) {
                    showToast(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, 'error');
                }
            }

            // ì—…ë¡œë“œ ê²°ê³¼ í‘œì‹œ (í‚¤ì›Œë“œ í¸ì§‘ ë²„íŠ¼ í¬í•¨)
            if (uploadResults.length > 0) {
                statusDiv.innerHTML = `
                    <div class="space-y-3">
                        <p class="text-green-600 font-medium">ì—…ë¡œë“œ ì™„ë£Œ!</p>
                        ${uploadResults.map(r => `
                            <div class="p-3 bg-gray-50 rounded-lg border">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-sm">${r.filename}</span>
                                    <button onclick="showEditModal(${r.entry_id})" class="text-blue-500 hover:text-blue-700 text-sm">í‚¤ì›Œë“œ í¸ì§‘</button>
                                </div>
                                <p class="text-xs text-gray-600">ì¶”ì¶œëœ í‚¤ì›Œë“œ (${r.keyword_count}ê°œ):</p>
                                <p class="text-xs text-gray-500 mt-1">${r.keywords || 'ì—†ìŒ'}</p>
                            </div>
                        `).join('')}
                        <p class="text-xs text-gray-400 mt-2">í‚¤ì›Œë“œëŠ” ëª©ë¡ì—ì„œ í¸ì§‘ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì–¸ì œë“  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = '<p class="text-red-600">ì—…ë¡œë“œ ì‹¤íŒ¨</p>';
            }

            loadKnowledge();
            tabDataLoaded.uploads = false; // ì—…ë¡œë“œ íƒ­ ìƒˆë¡œê³ ì¹¨ í•„ìš”
        }

        // Gemini File Search
        async function loadGeminiStores() {
            const container = document.getElementById('geminiStoresList');
            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/gemini/stores`);
                const data = await res.json();
                if (data.stores && data.stores.length > 0) {
                    container.innerHTML = data.stores.map(s => `
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="font-medium">${s.display_name}</p>
                            <p class="text-xs text-gray-500">${s.store_name}</p>
                            <p class="text-xs text-gray-400">${s.created_at}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-400 text-sm">ë“±ë¡ëœ Storeê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = `<p class="text-red-400 text-sm">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</p>`;
            }
        }

        async function uploadGeminiFiles(files) {
            const statusDiv = document.getElementById('geminiUploadStatus');
            const storeName = document.getElementById('geminiStoreName').value;
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="flex items-center text-blue-600"><div class="spinner mr-2"></div>Geminiì— ì—…ë¡œë“œ ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</div>';

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('store_name', storeName);

                try {
                    const res = await adminFetch(`${API_BASE_URL}/api/admin/gemini/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        showToast(`${file.name} Gemini ì—…ë¡œë“œ ì™„ë£Œ`, 'success');
                    } else {
                        showToast(`${file.name}: ${data.detail || 'ì—…ë¡œë“œ ì‹¤íŒ¨'}`, 'error');
                    }
                } catch (err) {
                    showToast(`${file.name} Gemini ì—…ë¡œë“œ ì‹¤íŒ¨`, 'error');
                }
            }

            statusDiv.innerHTML = '<p class="text-green-600">ì—…ë¡œë“œ ì™„ë£Œ</p>';
            loadGeminiStores();
            loadUploads();
        }

        // íšŒì› ê´€ë¦¬
        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/users`);
                const data = await res.json();
                if (data.users && data.users.length > 0) {
                    tbody.innerHTML = data.users.map(u => `
                        <tr>
                            <td>${u.id}</td>
                            <td>
                                ${u.profile_image ? `<img src="${u.profile_image}" class="w-8 h-8 rounded-full">` : '<div class="w-8 h-8 bg-gray-200 rounded-full"></div>'}
                            </td>
                            <td class="font-medium">${u.name || '-'}</td>
                            <td>${u.nickname || '-'}</td>
                            <td class="text-xs">${u.birthdate || '-'}</td>
                            <td><span class="px-2 py-1 ${u.gender === 'male' ? 'bg-blue-100 text-blue-700' : u.gender === 'female' ? 'bg-pink-100 text-pink-700' : 'bg-gray-100 text-gray-500'} rounded text-xs">${u.gender === 'male' ? 'ë‚¨ì„±' : u.gender === 'female' ? 'ì—¬ì„±' : '-'}</span></td>
                            <td>${u.email || '-'}</td>
                            <td>${u.phone || '-'}</td>
                            <td class="text-xs text-gray-500">${u.created_at || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-400 py-8">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-red-400 py-8">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</td></tr>`;
            }
        }

        // ìƒë‹´ ë‚´ì—­
        async function loadConsultations() {
            const tbody = document.getElementById('consultationsTableBody');
            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/consultations?limit=100`);
                const data = await res.json();
                if (data.consultations && data.consultations.length > 0) {
                    tbody.innerHTML = data.consultations.map(c => `
                        <tr>
                            <td>${c.id}</td>
                            <td>${c.nickname}</td>
                            <td class="max-w-xs truncate" title="${c.query}">${c.query.substring(0, 50)}...</td>
                            <td class="text-xs text-gray-500">${c.created_at}</td>
                            <td>
                                <button onclick="showConsultation(${c.id}, '${escapeHtml(c.query)}', '${escapeHtml(c.response_html || '')}')" class="text-blue-500 hover:text-blue-700 text-sm">ìƒì„¸</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-400 py-8">ìƒë‹´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-red-400 py-8">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</td></tr>`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
        }

        function showConsultation(id, query, html) {
            const modal = document.getElementById('consultationModal');
            const content = document.getElementById('consultationModalContent');
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-medium text-gray-700 mb-2">ì§ˆë¬¸</h4>
                    <p class="bg-gray-50 p-3 rounded">${query.replace(/\\n/g, '<br>')}</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">ë‹µë³€</h4>
                    <div class="bg-gray-50 p-3 rounded">${html.replace(/\\n/g, '<br>').replace(/\\'/g, "'").replace(/\\"/g, '"') || '<p class="text-gray-400">ë‹µë³€ ì—†ìŒ</p>'}</div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function closeConsultationModal() {
            document.getElementById('consultationModal').classList.add('hidden');
        }

        // ì—…ë¡œë“œ ê¸°ë¡
        async function loadUploads() {
            const tbody = document.getElementById('uploadsTableBody');
            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/uploads`);
                const data = await res.json();
                if (data.files && data.files.length > 0) {
                    tbody.innerHTML = data.files.map(f => `
                        <tr>
                            <td>${f.id}</td>
                            <td class="font-medium">${f.filename}</td>
                            <td>${f.file_type || '-'}</td>
                            <td><span class="px-2 py-1 ${f.destination === 'gemini' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'} rounded text-xs">${f.destination}</span></td>
                            <td class="text-xs text-gray-500">${f.store_name || '-'}</td>
                            <td><span class="px-2 py-1 ${f.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} rounded text-xs">${f.status}</span></td>
                            <td class="text-xs text-gray-500">${f.created_at}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-400 py-8">ì—…ë¡œë“œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-red-400 py-8">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</td></tr>`;
            }
        }

        // ëŒ€ë©´ìƒë‹´ ì‹ ì²­
        async function loadMeetingRequests() {
            const tbody = document.getElementById('meetingRequestsTableBody');
            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/consultation-requests?limit=100`);
                const data = await res.json();
                const statusFilter = document.getElementById('meetingStatusFilter').value;

                let requests = data.requests || [];
                if (statusFilter) {
                    requests = requests.filter(r => r.status === statusFilter);
                }

                if (requests.length > 0) {
                    tbody.innerHTML = requests.map(r => `
                        <tr>
                            <td>${r.id}</td>
                            <td><span class="px-2 py-1 ${r.type === 'tax' ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'} rounded text-xs font-medium">${r.type === 'tax' ? 'ì„¸ë¬´ì‚¬' : 'ë³€í˜¸ì‚¬'}</span></td>
                            <td class="font-medium">${r.name}</td>
                            <td>${r.phone}</td>
                            <td>${r.preferred_date}</td>
                            <td class="max-w-xs truncate" title="${r.content}">${r.content.substring(0, 30)}${r.content.length > 30 ? '...' : ''}</td>
                            <td><span class="px-2 py-1 ${getStatusStyle(r.status)} rounded text-xs">${getStatusLabel(r.status)}</span></td>
                            <td>
                                <div class="flex items-center space-x-1">
                                    ${r.kakao_sent ? '<span class="text-yellow-500" title="ì¹´ì¹´ì˜¤ ë°œì†¡ë¨">ğŸ’¬</span>' : '<span class="text-gray-300" title="ì¹´ì¹´ì˜¤ ë¯¸ë°œì†¡">ğŸ’¬</span>'}
                                    ${r.push_sent > 0 ? '<span class="text-blue-500" title="í‘¸ì‹œ ë°œì†¡ë¨">ğŸ””</span>' : '<span class="text-gray-300" title="í‘¸ì‹œ ë¯¸ë°œì†¡">ğŸ””</span>'}
                                </div>
                            </td>
                            <td class="text-xs text-gray-500">${r.created_at}</td>
                            <td>
                                <button onclick="updateMeetingStatus(${r.id}, '${r.status}')" class="text-blue-500 hover:text-blue-700 text-sm">ë³€ê²½</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-400 py-8">ëŒ€ë©´ìƒë‹´ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                }
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="10" class="text-center text-red-400 py-8">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</td></tr>`;
            }
        }

        function getStatusLabel(status) {
            const labels = { pending: 'ëŒ€ê¸°ì¤‘', confirmed: 'í™•ì •', completed: 'ì™„ë£Œ', cancelled: 'ì·¨ì†Œ' };
            return labels[status] || status;
        }

        function getStatusStyle(status) {
            const styles = {
                pending: 'bg-yellow-100 text-yellow-700',
                confirmed: 'bg-blue-100 text-blue-700',
                completed: 'bg-green-100 text-green-700',
                cancelled: 'bg-gray-100 text-gray-500'
            };
            return styles[status] || 'bg-gray-100 text-gray-500';
        }

        async function updateMeetingStatus(id, currentStatus) {
            const newStatus = prompt(`ìƒíƒœ ë³€ê²½ (pending/confirmed/completed/cancelled)\ní˜„ì¬: ${currentStatus}`, currentStatus);
            if (!newStatus || newStatus === currentStatus) return;

            const note = prompt('ê´€ë¦¬ì ë©”ëª¨ (ì„ íƒì‚¬í•­):', '');

            try {
                const formData = new FormData();
                formData.append('status', newStatus);
                if (note) formData.append('admin_note', note);

                const res = await fetch(`${API_BASE_URL}/api/admin/consultation-requests/${id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${adminToken}` },
                    body: formData
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadMeetingRequests();
                } else {
                    showToast('ë³€ê²½ ì‹¤íŒ¨', 'error');
                }
            } catch (err) {
                showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }

        // RAG ìƒíƒœ í™•ì¸
        async function loadRagStatus() {
            try {
                const res = await adminFetch(`${API_BASE_URL}/api/admin/rag/status`);
                const data = await res.json();
                const panel = document.getElementById('ragStatusPanel');
                const content = document.getElementById('ragStatusContent');

                if (data.rag_status) {
                    const fts5 = data.rag_status.fts5;
                    const gemini = data.rag_status.gemini;

                    content.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="font-medium">FTS5 í‚¤ì›Œë“œ ê²€ìƒ‰</p>
                                <p class="${fts5.status === 'ok' ? 'text-green-600' : 'text-red-600'}">
                                    ${fts5.status === 'ok' ? 'ì •ìƒ' : 'ì˜¤ë¥˜'}
                                </p>
                                <p class="text-gray-500">ë“±ë¡ëœ ì§€ì‹: ${fts5.count || 0}ê°œ</p>
                            </div>
                            <div>
                                <p class="font-medium">Gemini File Search</p>
                                <p class="${gemini.api_key_set ? 'text-green-600' : 'text-yellow-600'}">
                                    API Key: ${gemini.api_key_set ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •'}
                                </p>
                                <p class="text-gray-500">ì—…ë¡œë“œëœ íŒŒì¼: ${gemini.file_count || 0}ê°œ</p>
                                <p class="text-gray-500">Store ìˆ˜: ${gemini.stores?.length || 0}ê°œ</p>
                            </div>
                        </div>
                    `;
                    panel.classList.remove('hidden');
                }
            } catch (err) {
                showToast('RAG ìƒíƒœ í™•ì¸ ì‹¤íŒ¨', 'error');
            }
        }

        // RAG í…ŒìŠ¤íŠ¸ í¼ (3ë‹¨ê³„ íŒŒì´í”„ë¼ì¸)
        document.getElementById('ragTestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = document.getElementById('ragTestQuery').value;
            const resultsDiv = document.getElementById('ragTestResults');
            const analysisDiv = document.getElementById('ragAnalysisResult');
            const fts5Pre = document.getElementById('ragFts5Result');
            const geminiPre = document.getElementById('ragGeminiResult');
            const combinedPre = document.getElementById('ragCombinedResult');

            analysisDiv.innerHTML = '<p class="text-yellow-600">1ë‹¨ê³„ ì§ˆë¬¸ ë¶„ì„ ì¤‘...</p>';
            fts5Pre.textContent = '2ë‹¨ê³„ ê²€ìƒ‰ ëŒ€ê¸° ì¤‘...';
            geminiPre.textContent = '2ë‹¨ê³„ ê²€ìƒ‰ ëŒ€ê¸° ì¤‘...';
            combinedPre.textContent = '3ë‹¨ê³„ í†µí•© ëŒ€ê¸° ì¤‘...';
            resultsDiv.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('query', query);

                const res = await adminFetch(`${API_BASE_URL}/api/admin/rag/test`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.results) {
                    // 1ë‹¨ê³„: ì§ˆë¬¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                    const analysis = data.results.step1_analysis;
                    if (analysis && !analysis.error) {
                        analysisDiv.innerHTML = `
                            <p><strong>ì˜ë„:</strong> ${analysis.intent || '-'}</p>
                            <p><strong>í•µì‹¬ ìŸì :</strong> ${(analysis.issues || []).join(', ') || '-'}</p>
                            <p><strong>ì •ë¦¬ëœ ì§ˆë¬¸:</strong> ${analysis.reformulated_query || '-'}</p>
                            <p><strong>í•µì‹¬ í‚¤ì›Œë“œ:</strong> <span class="text-blue-600">${(analysis.keywords || []).join(', ') || '-'}</span></p>
                            <p><strong>í™•ì¥ í‚¤ì›Œë“œ:</strong> <span class="text-purple-600">${(analysis.expanded_keywords || []).join(', ') || '-'}</span></p>
                        `;
                    } else {
                        analysisDiv.innerHTML = `<p class="text-red-500">${analysis?.error || 'ë¶„ì„ ì‹¤íŒ¨'}</p>`;
                    }

                    // 2ë‹¨ê³„: ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
                    fts5Pre.textContent = data.results.step2_fts5_result || 'ê²°ê³¼ ì—†ìŒ';
                    geminiPre.textContent = data.results.step2_gemini_result || 'ê²°ê³¼ ì—†ìŒ';

                    // 3ë‹¨ê³„: í†µí•© ê²°ê³¼ í‘œì‹œ
                    combinedPre.textContent = data.results.step3_combined || 'í†µí•© ê²°ê³¼ ì—†ìŒ';
                }
            } catch (err) {
                analysisDiv.innerHTML = '<p class="text-red-500">ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ</p>';
                fts5Pre.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
                geminiPre.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
                combinedPre.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
                showToast('RAG í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error');
            }
        });

        // í† ìŠ¤íŠ¸
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        ['fts5UploadZone', 'geminiUploadZone'].forEach(id => {
            const zone = document.getElementById(id);
            if (!zone) return;

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (id === 'fts5UploadZone') {
                    uploadFTS5Files(files);
                } else {
                    uploadGeminiFiles(files);
                }
            });
        });
    </script>
</body>
</html>
