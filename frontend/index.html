<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="2025년 귀속 양도소득세 계산기 - 공인중개사를 위한 실시간 양도세 계산 및 AI 세무상담">
    <title>2025 양도소득세 AI 컨설팅</title>

    <!-- 환경변수 설정 - Railway API URL -->
    <script src="./env.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }

        .report-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
        .report-section:last-of-type { border-bottom: none; }
        .report-section h3 { color: #1e40af; font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; padding-left: 0.75rem; border-left: 3px solid #3b82f6; }
        .report-section p { color: #374151; line-height: 1.7; font-size: 0.9rem; }
        .report-section ul { list-style-type: disc; padding-left: 1.5rem; color: #374151; }
        .report-section li { margin-bottom: 0.5rem; line-height: 1.6; }
        .conclusion-box { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 1rem; border-radius: 0.5rem; border: 1px solid #bfdbfe; }
        .conclusion-box p { color: #1e40af; font-weight: 500; }
        .knowledge-box { background: #f8fafc; padding: 1rem; border-radius: 0.5rem; font-size: 0.85rem; line-height: 1.8; }
        .report-footer { margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 0.8rem; }
        .error-note { background: #fef2f2; color: #991b1b; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.85rem; margin-top: 0.5rem; }
        .tab-active { background: white; color: #1e40af; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 0.5rem; z-index: 50; display: none; }
        @media (max-width: 768px) { .mobile-nav { display: flex; } main { padding-bottom: 80px; } }

        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .result-highlight { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 1.5rem; border-radius: 1rem; text-align: center; }

        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 1rem; max-width: 400px; width: 90%; max-height: 90vh; overflow-y: auto; }

        .kakao-btn { background: #FEE500; color: #000000; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border-radius: 8px; transition: all 0.2s; }
        .kakao-btn:hover { background: #FDD835; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold">2025 양도소득세</h1>
                        <p class="text-xs text-blue-200">AI 전문 컨설팅</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <nav class="hidden md:flex bg-blue-900/30 p-1 rounded-lg">
                        <button onclick="switchTab('calc')" id="btn-calc-desktop" class="px-4 py-2 rounded-md text-sm font-medium transition tab-active">계산기</button>
                        <button onclick="switchTab('consult')" id="btn-consult-desktop" class="px-4 py-2 rounded-md text-sm font-medium transition text-blue-200 hover:text-white">AI 상담</button>
                        <button onclick="switchTab('meeting')" id="btn-meeting-desktop" class="px-4 py-2 rounded-md text-sm font-medium transition text-blue-200 hover:text-white">대면상담</button>
                    </nav>
                    <!-- 로그인 영역 -->
                    <div id="authArea">
                        <button onclick="showLoginModal()" id="loginBtn" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <span>로그인</span>
                        </button>
                        <div id="userProfile" class="hidden flex items-center space-x-2">
                            <img id="userProfileImg" src="" alt="" class="w-8 h-8 rounded-full bg-white/20">
                            <span id="userNickname" class="text-sm font-medium"></span>
                            <button onclick="logout()" class="ml-2 px-2 py-1 text-xs bg-white/20 hover:bg-white/30 rounded transition">로그아웃</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-4 md:py-6">
        <!-- Calculator Tab -->
        <section id="tab-calc" class="block animate-fadeIn">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 lg:gap-6">
                <!-- Input Form -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-4 py-3 text-white">
                        <h2 class="font-semibold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            매물 정보 입력
                        </h2>
                    </div>

                    <form id="calcForm" class="p-4 space-y-4">
                        <div class="space-y-3">
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide">거래 일자</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">취득일</label>
                                    <input type="date" name="acquisition_date" min="1900-01-01" max="2099-12-31" required class="w-full px-3 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">양도일</label>
                                    <input type="date" name="transfer_date" min="1900-01-01" max="2099-12-31" required class="w-full px-3 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide">거래 금액</label>
                            <div class="space-y-2">
                                <div class="relative">
                                    <input type="text" name="acquisition_price" required placeholder="취득가액" class="w-full px-3 py-2.5 pr-12 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" oninput="formatNumberInput(this)">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">원</span>
                                </div>
                                <div class="relative">
                                    <input type="text" name="transfer_price" required placeholder="양도가액" class="w-full px-3 py-2.5 pr-12 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" oninput="formatNumberInput(this)">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">원</span>
                                </div>
                                <div class="relative">
                                    <input type="text" name="necessary_expenses" placeholder="필요경비 (취득세, 중개보수 등)" class="w-full px-3 py-2.5 pr-12 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" oninput="formatNumberInput(this)">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">원</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">자산 유형</label>
                            <select name="asset_type" class="w-full px-3 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition appearance-none cursor-pointer">
                                <option value="housing">주택 (아파트/빌라/단독)</option>
                                <option value="land">토지 (일반)</option>
                                <option value="land_nonbiz">토지 (비사업용)</option>
                                <option value="building">상가/오피스</option>
                                <option value="right">분양권/입주권</option>
                            </select>
                        </div>

                        <div class="border border-gray-200 rounded-xl overflow-hidden">
                            <button type="button" onclick="toggleAdvanced()" class="w-full px-4 py-3 bg-gradient-to-r from-blue-50 to-indigo-50 flex items-center justify-between text-left">
                                <span class="text-sm font-medium text-blue-700">특례 및 감면 설정</span>
                                <svg id="advIcon" class="w-5 h-5 text-blue-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>

                            <div id="advOptions" class="hidden px-4 py-4 bg-white space-y-4 border-t border-gray-100">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" name="is_1h1h" id="is_1h1h" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-700">1세대 1주택 (비과세/고가주택)</span>
                                </label>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">실거주 기간 (년)</label>
                                    <input type="number" name="residence_years" value="0" min="0" max="50" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                </div>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" name="is_adjusted_area" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-700">조정대상지역 소재</span>
                                </label>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">보유 주택 수</label>
                                    <select name="housing_count" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                        <option value="1">1주택</option>
                                        <option value="2">2주택</option>
                                        <option value="3">3주택 이상</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">세액감면 대상</label>
                                    <select name="reduction_type" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                        <option value="none">해당없음</option>
                                        <option value="farming_8yr">8년 자경농지 (100% 감면)</option>
                                        <option value="public_cash">공익사업 수용 - 현금보상 (10%)</option>
                                        <option value="public_bond_3yr">공익사업 수용 - 3년 채권 (40%)</option>
                                        <option value="public_bond_5yr">공익사업 수용 - 5년 채권 (15%)</option>
                                    </select>
                                </div>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" name="is_registered" checked class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-700">등기 완료</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" id="calcBtn" class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 transition transform active:scale-[0.98]">
                            <span id="calcBtnText">세금 계산하기</span>
                            <div id="calcBtnSpinner" class="hidden spinner mx-auto"></div>
                        </button>
                    </form>
                </div>

                <!-- Results -->
                <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-500 px-4 py-3 text-white flex items-center justify-between">
                        <h2 class="font-semibold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            계산 결과
                        </h2>
                        <button onclick="downloadCalcPDF()" id="downloadPdfBtn" class="hidden px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-xs font-medium transition">PDF 저장</button>
                    </div>

                    <div id="resultContainer" class="p-4 min-h-[400px] flex items-center justify-center">
                        <div id="emptyState" class="text-center text-gray-400 py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-sm">매물 정보를 입력하고<br><strong>계산하기</strong> 버튼을 눌러주세요</p>
                        </div>

                        <div id="calcResult" class="hidden w-full animate-fadeIn">
                            <div id="printArea">
                                <div class="result-highlight mb-6">
                                    <p class="text-sm text-blue-200 mb-1">총 납부세액</p>
                                    <p class="text-3xl md:text-4xl font-bold" id="res_total">0원</p>
                                    <p class="text-xs text-blue-200 mt-2" id="res_rate_note"></p>
                                </div>

                                <div class="space-y-3">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600 text-sm">양도차익</span>
                                        <span class="font-medium" id="res_gross">0원</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600 text-sm">(-) 장기보유특별공제</span>
                                        <span class="font-medium text-blue-600" id="res_lthsd">0원</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600 text-sm">(-) 양도소득기본공제</span>
                                        <span class="font-medium text-blue-600" id="res_basic">0원</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100 bg-gray-50 -mx-2 px-2 rounded">
                                        <span class="text-gray-700 text-sm font-medium">과세표준</span>
                                        <span class="font-semibold" id="res_base">0원</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600 text-sm">산출세액</span>
                                        <span class="font-medium" id="res_calc">0원</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600 text-sm">(-) 세액감면</span>
                                        <span class="font-medium text-green-600" id="res_reduction">0원</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600 text-sm">결정세액 (소득세)</span>
                                        <span class="font-medium" id="res_final">0원</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600 text-sm">(+) 지방소득세 (10%)</span>
                                        <span class="font-medium" id="res_local">0원</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600 text-sm">(+) 농어촌특별세</span>
                                        <span class="font-medium" id="res_rural">0원</span>
                                    </div>
                                </div>

                                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-blue-700">보유기간</span>
                                        <span class="font-medium text-blue-800" id="res_holding">-</span>
                                    </div>
                                    <div class="flex items-center justify-between text-sm mt-1">
                                        <span class="text-blue-700">실효세율</span>
                                        <span class="font-medium text-blue-800" id="res_effective">-</span>
                                    </div>
                                </div>

                                <div id="warningsContainer" class="mt-4 hidden">
                                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                        <p class="text-xs font-medium text-amber-800 mb-1">주의사항</p>
                                        <ul id="warningsList" class="text-xs text-amber-700 space-y-1"></ul>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 pt-4 border-t border-gray-100">
                                <button onclick="goToConsultWithData()" class="w-full py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-700 hover:to-purple-700 text-white font-medium rounded-xl transition flex items-center justify-center space-x-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                    </svg>
                                    <span>이 결과로 AI 상담받기</span>
                                </button>
                            </div>

                            <p class="text-xs text-gray-400 mt-4 text-center">본 계산 결과는 참고용이며, 실제 세액과 다를 수 있습니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Consultation Tab -->
        <section id="tab-consult" class="hidden animate-fadeIn">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="flex flex-col lg:flex-row h-auto lg:h-[700px]">
                    <div class="flex-1 flex flex-col">
                        <div class="bg-gradient-to-r from-violet-600 to-purple-600 px-4 py-3 text-white">
                            <h2 class="font-semibold flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                AI 세무사 상담
                                <span class="ml-2 px-2 py-0.5 bg-white/20 rounded text-xs">Gemini Pro</span>
                            </h2>
                            <p class="text-xs text-purple-200 mt-1">양도소득세 전문 AI가 보고서 형식으로 답변해 드립니다</p>
                        </div>

                        <div id="chatHistory" class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4 min-h-[300px] lg:min-h-0">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <div class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm max-w-[85%]">
                                    <p class="text-sm text-gray-700 leading-relaxed">
                                        안녕하세요! 30년 경력의 양도소득세 전문 AI 세무사입니다.<br><br>
                                        복잡한 양도세 규정, 비과세 요건, 감면 조건 등 무엇이든 물어보세요.
                                    </p>
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        <button onclick="setQuickQuestion('1세대1주택 비과세 요건이 어떻게 되나요?')" class="px-3 py-1.5 bg-purple-50 text-purple-700 text-xs rounded-full hover:bg-purple-100 transition">1세대1주택 비과세</button>
                                        <button onclick="setQuickQuestion('일시적 2주택 비과세 조건을 알려주세요')" class="px-3 py-1.5 bg-purple-50 text-purple-700 text-xs rounded-full hover:bg-purple-100 transition">일시적 2주택</button>
                                        <button onclick="setQuickQuestion('장기보유특별공제 계산 방법을 설명해주세요')" class="px-3 py-1.5 bg-purple-50 text-purple-700 text-xs rounded-full hover:bg-purple-100 transition">장기보유특별공제</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-white border-t border-gray-100">
                            <form id="chatForm" class="flex gap-2">
                                <input type="text" id="userQuery" required class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent transition" placeholder="양도소득세에 대해 질문해 주세요...">
                                <button type="submit" id="sendBtn" class="px-5 py-3 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-700 hover:to-purple-700 text-white font-medium rounded-xl transition flex items-center justify-center min-w-[80px]">
                                    <span id="sendBtnText">전송</span>
                                    <div id="sendBtnSpinner" class="hidden spinner"></div>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div id="reportPreview" class="hidden lg:flex w-full lg:w-1/2 bg-gray-50 border-l border-gray-200 flex-col">
                        <div class="px-4 py-3 bg-white border-b border-gray-200 flex items-center justify-between">
                            <h3 class="font-medium text-gray-700 text-sm">상담 보고서</h3>
                            <button onclick="downloadReportPDF()" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded-lg transition flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                <span>PDF 다운로드</span>
                            </button>
                        </div>
                        <div id="reportContent" class="flex-1 overflow-y-auto p-6">
                            <div class="h-full flex flex-col items-center justify-center text-gray-400">
                                <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-sm text-center">상담 결과가<br>보고서 형태로 표시됩니다</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- In-Person Consultation Tab -->
        <section id="tab-meeting" class="hidden animate-fadeIn">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">대면 상담 신청</h2>
                    <p class="text-gray-500">전문가와 직접 상담하세요</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 세무사 상담 카드 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-shadow">
                        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4 text-white">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold">세무사 대면상담</h3>
                                    <p class="text-emerald-100 text-sm">양도소득세 전문 세무사</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <ul class="space-y-3 mb-6">
                                <li class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-emerald-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-gray-600">복잡한 양도세 절세 전략 상담</span>
                                </li>
                                <li class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-emerald-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-gray-600">다주택자 세금 최적화 방안</span>
                                </li>
                                <li class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-emerald-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-gray-600">비과세/감면 요건 검토</span>
                                </li>
                                <li class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-emerald-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-gray-600">신고서 작성 및 제출 대행</span>
                                </li>
                            </ul>
                            <button onclick="showConsultationModal('tax')" class="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-semibold rounded-xl transition flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <span>상담 신청하기</span>
                            </button>
                        </div>
                    </div>

                    <!-- 변호사 상담 카드 -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-shadow">
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 text-white">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold">변호사 대면상담</h3>
                                    <p class="text-indigo-100 text-sm">부동산/세무 전문 변호사</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <ul class="space-y-3 mb-6">
                                <li class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-indigo-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-gray-600">부동산 거래 관련 법률 검토</span>
                                </li>
                                <li class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-indigo-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-gray-600">세무조사 대응 및 불복 절차</span>
                                </li>
                                <li class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-indigo-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-gray-600">조세심판/행정소송 대리</span>
                                </li>
                                <li class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-indigo-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-gray-600">계약서 검토 및 분쟁 해결</span>
                                </li>
                            </ul>
                            <button onclick="showConsultationModal('lawyer')" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-xl transition flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <span>상담 신청하기</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 안내 사항 -->
                <div class="mt-8 bg-amber-50 border border-amber-200 rounded-xl p-6">
                    <div class="flex items-start space-x-3">
                        <svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <h4 class="font-semibold text-amber-800 mb-2">상담 안내</h4>
                            <ul class="text-sm text-amber-700 space-y-1">
                                <li>• 상담 신청 후 담당자가 연락드립니다.</li>
                                <li>• 상담 일정은 상호 협의하여 조정됩니다.</li>
                                <li>• 상담 비용은 첫 상담 시 안내드립니다.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav justify-around">
        <button onclick="switchTab('calc')" id="btn-calc-mobile" class="flex flex-col items-center py-2 px-4 text-blue-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            <span class="text-xs mt-1 font-medium">계산기</span>
        </button>
        <button onclick="switchTab('consult')" id="btn-consult-mobile" class="flex flex-col items-center py-2 px-4 text-gray-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <span class="text-xs mt-1 font-medium">AI 상담</span>
        </button>
        <button onclick="switchTab('meeting')" id="btn-meeting-mobile" class="flex flex-col items-center py-2 px-4 text-gray-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <span class="text-xs mt-1 font-medium">대면상담</span>
        </button>
    </nav>

    <!-- 로그인 모달 -->
    <div id="loginModal" class="modal-backdrop hidden" onclick="if(event.target === this) hideLoginModal()">
        <div class="modal-content p-6 max-w-md">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">로그인</h3>
                <p class="text-sm text-gray-500 mt-2">서비스 이용을 위해 로그인해 주세요</p>
            </div>

            <!-- 일반 로그인 폼 -->
            <form id="loginForm" class="space-y-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이메일 (아이디)</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="이메일 입력" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">전화번호 (비밀번호)</label>
                    <input type="tel" id="loginPhone" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="010-0000-0000" required>
                </div>
                <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">로그인</button>
            </form>

            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">또는</span></div>
            </div>

            <button onclick="loginWithKakao()" class="kakao-btn w-full mb-4">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M10 2C5.58172 2 2 4.91015 2 8.5C2 10.7518 3.38508 12.7297 5.5 13.8711V17.5L9.13434 14.8633C9.4181 14.9205 9.70549 14.95 10 14.95C14.4183 14.95 18 12.0399 18 8.45C18 4.86015 14.4183 2 10 2Z" fill="black"/>
                </svg>
                카카오로 로그인
            </button>

            <p class="text-center text-sm text-gray-500">
                계정이 없으신가요? <button type="button" onclick="showRegisterModal()" class="text-blue-600 hover:underline font-medium">회원가입</button>
            </p>
        </div>
    </div>

    <!-- 회원가입 모달 -->
    <div id="registerModal" class="modal-backdrop hidden" onclick="if(event.target === this) hideRegisterModal()">
        <div class="modal-content p-6 max-w-md max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">회원가입</h3>
                <p class="text-sm text-gray-500 mt-2">서비스 이용을 위해 가입해 주세요</p>
            </div>

            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이메일 (아이디) <span class="text-red-500">*</span></label>
                    <input type="email" id="regEmail" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="이메일 입력" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">전화번호 (비밀번호) <span class="text-red-500">*</span></label>
                    <input type="tel" id="regPhone" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="010-0000-0000" required>
                    <p class="text-xs text-gray-400 mt-1">로그인 시 비밀번호로 사용됩니다</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이름 <span class="text-red-500">*</span></label>
                    <input type="text" id="regName" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="실명 입력" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">생년월일</label>
                    <input type="date" id="regBirthdate" min="1900-01-01" max="2024-12-31" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="YYYY-MM-DD">
                    <p class="text-xs text-gray-400 mt-1">형식: YYYY-MM-DD (예: 1990-01-15)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">성별</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="regGender" value="male" class="w-5 h-5 text-blue-600">
                            <span class="ml-2 text-gray-700">남성</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="regGender" value="female" class="w-5 h-5 text-blue-600">
                            <span class="ml-2 text-gray-700">여성</span>
                        </label>
                    </div>
                </div>

                <!-- 약관 동의 -->
                <div class="pt-4 border-t border-gray-200 space-y-3">
                    <div class="flex items-start space-x-2">
                        <input type="checkbox" id="agreeAll" class="w-5 h-5 mt-0.5 text-blue-600 rounded" onchange="toggleAllAgree()">
                        <label for="agreeAll" class="text-sm font-medium text-gray-800">전체 동의</label>
                    </div>
                    <div class="flex items-start space-x-2 ml-6">
                        <input type="checkbox" id="agreeTerms" class="w-5 h-5 mt-0.5 text-blue-600 rounded" required>
                        <label for="agreeTerms" class="text-sm text-gray-600">[필수] 이용약관 동의 <button type="button" onclick="showTermsModal()" class="text-blue-600 hover:underline">(보기)</button></label>
                    </div>
                    <div class="flex items-start space-x-2 ml-6">
                        <input type="checkbox" id="agreePrivacy" class="w-5 h-5 mt-0.5 text-blue-600 rounded" required>
                        <label for="agreePrivacy" class="text-sm text-gray-600">[필수] 개인정보처리방침 동의 <button type="button" onclick="showPrivacyModal()" class="text-blue-600 hover:underline">(보기)</button></label>
                    </div>
                </div>

                <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">회원가입</button>
                <p class="text-center text-sm text-gray-500">
                    이미 계정이 있으신가요? <button type="button" onclick="showLoginFromRegister()" class="text-blue-600 hover:underline font-medium">로그인</button>
                </p>
            </form>
        </div>
    </div>

    <!-- 이용약관 모달 -->
    <div id="termsModal" class="modal-backdrop hidden" onclick="if(event.target === this) hideTermsModal()">
        <div class="modal-content p-6 max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">이용약관</h3>
                <button onclick="hideTermsModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="prose prose-sm max-w-none text-gray-700">
                <h4 class="font-semibold">제1조 (목적)</h4>
                <p>본 약관은 양도소득세 AI 컨설팅 서비스(이하 "서비스")의 이용조건 및 절차, 회사와 회원 간의 권리, 의무 및 책임사항을 규정함을 목적으로 합니다.</p>

                <h4 class="font-semibold mt-4">제2조 (용어의 정의)</h4>
                <p>1. "서비스"란 회사가 제공하는 양도소득세 계산, AI 세무상담, 대면상담 연결 등의 서비스를 의미합니다.</p>
                <p>2. "회원"이란 본 약관에 동의하고 회원가입을 완료한 자를 의미합니다.</p>

                <h4 class="font-semibold mt-4">제3조 (서비스의 제공)</h4>
                <p>1. 회사는 다음과 같은 서비스를 제공합니다.</p>
                <ul class="list-disc ml-4">
                    <li>양도소득세 계산 서비스</li>
                    <li>AI 기반 세무상담 서비스</li>
                    <li>세무사/변호사 대면상담 연결 서비스</li>
                </ul>
                <p>2. 서비스 내용은 회사의 정책에 따라 변경될 수 있습니다.</p>

                <h4 class="font-semibold mt-4">제4조 (회원가입)</h4>
                <p>1. 회원가입은 이용자가 본 약관에 동의하고 회원정보를 입력하여 완료합니다.</p>
                <p>2. 회사는 다음의 경우 회원가입을 거부할 수 있습니다.</p>
                <ul class="list-disc ml-4">
                    <li>타인의 정보를 도용한 경우</li>
                    <li>허위 정보를 입력한 경우</li>
                    <li>기타 회원가입이 부적절하다고 판단되는 경우</li>
                </ul>

                <h4 class="font-semibold mt-4">제5조 (서비스 이용의 제한)</h4>
                <p>본 서비스에서 제공하는 계산 결과 및 AI 상담 내용은 참고용이며, 실제 세금 신고 및 납부는 반드시 전문 세무사와 상담 후 진행하시기 바랍니다.</p>

                <h4 class="font-semibold mt-4">제6조 (면책조항)</h4>
                <p>1. 회사는 서비스를 통해 제공된 정보의 정확성, 완전성, 적시성을 보장하지 않습니다.</p>
                <p>2. 회원이 서비스를 통해 얻은 정보에 기반한 결정으로 발생한 손해에 대해 회사는 책임을 지지 않습니다.</p>

                <h4 class="font-semibold mt-4">제7조 (분쟁 해결)</h4>
                <p>서비스 이용과 관련하여 발생한 분쟁에 대해서는 대한민국 법률을 적용하며, 관할 법원은 회사 소재지 법원으로 합니다.</p>

                <p class="mt-4 text-gray-500">시행일: 2025년 1월 1일</p>
            </div>
            <button onclick="hideTermsModal()" class="w-full mt-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition">닫기</button>
        </div>
    </div>

    <!-- 개인정보처리방침 모달 -->
    <div id="privacyModal" class="modal-backdrop hidden" onclick="if(event.target === this) hidePrivacyModal()">
        <div class="modal-content p-6 max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">개인정보처리방침</h3>
                <button onclick="hidePrivacyModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="prose prose-sm max-w-none text-gray-700">
                <h4 class="font-semibold">1. 개인정보의 수집 및 이용 목적</h4>
                <p>회사는 다음의 목적을 위해 개인정보를 수집 및 이용합니다.</p>
                <ul class="list-disc ml-4">
                    <li>회원 가입 및 관리: 회원 식별, 서비스 제공, 상담 이력 관리</li>
                    <li>서비스 제공: 양도소득세 계산, AI 상담, 대면상담 연결</li>
                    <li>고객 문의 응대: 문의사항 처리, 공지사항 전달</li>
                </ul>

                <h4 class="font-semibold mt-4">2. 수집하는 개인정보 항목</h4>
                <p>회사는 다음의 개인정보를 수집합니다.</p>
                <ul class="list-disc ml-4">
                    <li>필수항목: 이메일, 전화번호, 이름</li>
                    <li>선택항목: 생년월일, 성별</li>
                    <li>카카오 로그인 시: 카카오 계정 정보, 프로필 이미지, 닉네임</li>
                </ul>

                <h4 class="font-semibold mt-4">3. 개인정보의 보유 및 이용 기간</h4>
                <p>회원 탈퇴 시까지 또는 법령에 따른 보존 기간까지 보유합니다.</p>
                <ul class="list-disc ml-4">
                    <li>회원 정보: 회원 탈퇴 시까지</li>
                    <li>상담 기록: 3년 (전자상거래법)</li>
                    <li>접속 로그: 3개월 (통신비밀보호법)</li>
                </ul>

                <h4 class="font-semibold mt-4">4. 개인정보의 제3자 제공</h4>
                <p>회사는 원칙적으로 이용자의 동의 없이 개인정보를 제3자에게 제공하지 않습니다. 다만, 대면상담 신청 시 해당 세무사/변호사에게 연락처가 제공될 수 있습니다.</p>

                <h4 class="font-semibold mt-4">5. 개인정보의 파기 절차 및 방법</h4>
                <p>개인정보는 보유 기간 종료 후 지체 없이 파기합니다.</p>
                <ul class="list-disc ml-4">
                    <li>전자적 파일: 복구 불가능한 방법으로 영구 삭제</li>
                    <li>종이 문서: 분쇄기로 파쇄</li>
                </ul>

                <h4 class="font-semibold mt-4">6. 이용자의 권리</h4>
                <p>이용자는 언제든지 자신의 개인정보를 조회, 수정, 삭제할 수 있으며, 회원 탈퇴를 요청할 수 있습니다.</p>

                <h4 class="font-semibold mt-4">7. 개인정보 보호책임자</h4>
                <p>개인정보 보호에 관한 문의는 아래 연락처로 문의해 주세요.</p>
                <ul class="list-disc ml-4">
                    <li>담당자: 개인정보보호 담당</li>
                    <li>이메일: privacy@lawith.kr</li>
                </ul>

                <p class="mt-4 text-gray-500">시행일: 2025년 1월 1일</p>
            </div>
            <button onclick="hidePrivacyModal()" class="w-full mt-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition">닫기</button>
        </div>
    </div>

    <!-- 로그인 필요 알림 모달 -->
    <div id="loginRequiredModal" class="modal-backdrop hidden" onclick="if(event.target === this) hideLoginRequiredModal()">
        <div class="modal-content p-6 text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">로그인이 필요합니다</h3>
            <p class="text-gray-500 mb-6">이 서비스를 이용하려면<br>로그인 또는 회원가입이 필요합니다.</p>
            <div class="space-y-3">
                <button onclick="hideLoginRequiredModal(); showLoginModal();" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">로그인하기</button>
                <button onclick="hideLoginRequiredModal(); showRegisterModal();" class="w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition">회원가입하기</button>
            </div>
        </div>
    </div>

    <!-- 추가 정보 입력 모달 -->
    <div id="additionalInfoModal" class="modal-backdrop hidden" onclick="if(event.target === this) hideAdditionalInfoModal()">
        <div class="modal-content p-6">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">추가 정보 입력</h3>
                <p class="text-sm text-gray-500 mt-2">서비스 이용을 위해 정보를 입력해 주세요</p>
            </div>
            <form id="additionalInfoForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이름 <span class="text-red-500">*</span></label>
                    <input type="text" id="additionalName" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="실명을 입력해 주세요" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">생년월일 <span class="text-red-500">*</span></label>
                    <input type="date" id="additionalBirthdate" min="1900-01-01" max="2099-12-31" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">성별 <span class="text-red-500">*</span></label>
                    <div class="flex space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="additionalGender" value="male" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500" required>
                            <span class="ml-2 text-gray-700">남성</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="additionalGender" value="female" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-2 text-gray-700">여성</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                    <input type="email" id="additionalEmail" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="이메일 주소">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">휴대폰 번호 <span class="text-red-500">*</span></label>
                    <input type="tel" id="additionalPhone" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="010-0000-0000" required>
                </div>
                <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">저장하기</button>
                <button type="button" onclick="hideAdditionalInfoModal()" class="w-full py-3 text-gray-500 hover:text-gray-700 text-sm">나중에 하기</button>
            </form>
        </div>
    </div>

    <!-- 대면상담 신청 모달 -->
    <div id="consultationModal" class="modal-backdrop hidden" onclick="if(event.target === this) hideConsultationModal()">
        <div class="modal-content p-6 max-w-md">
            <div class="text-center mb-6">
                <div id="consultModalIcon" class="w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center bg-gradient-to-r from-emerald-600 to-teal-600">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h3 id="consultModalTitle" class="text-xl font-bold text-gray-800">세무사 대면상담 신청</h3>
                <p class="text-sm text-gray-500 mt-2">상담 정보를 입력해 주세요</p>
            </div>
            <form id="consultationForm" class="space-y-4">
                <input type="hidden" id="consultationType" value="tax">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이름 <span class="text-red-500">*</span></label>
                    <input type="text" id="consultName" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="실명을 입력해 주세요" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">연락처 <span class="text-red-500">*</span></label>
                    <input type="tel" id="consultPhone" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="010-0000-0000" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                    <input type="email" id="consultEmail" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="이메일 주소 (선택)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">희망 상담일 <span class="text-red-500">*</span></label>
                    <input type="date" id="consultDate" min="1900-01-01" max="2099-12-31" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">상담 내용 <span class="text-red-500">*</span></label>
                    <textarea id="consultContent" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" placeholder="상담받고 싶은 내용을 간략히 입력해 주세요" required></textarea>
                </div>
                <div class="flex items-start space-x-2">
                    <input type="checkbox" id="consultAgree" class="w-5 h-5 mt-0.5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" required>
                    <label for="consultAgree" class="text-sm text-gray-600">개인정보 수집 및 이용에 동의합니다. <span class="text-red-500">*</span></label>
                </div>
                <button type="submit" id="consultSubmitBtn" class="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-semibold rounded-lg transition flex items-center justify-center space-x-2">
                    <span id="consultSubmitText">상담 신청하기</span>
                    <div id="consultSubmitSpinner" class="hidden spinner"></div>
                </button>
                <button type="button" onclick="hideConsultationModal()" class="w-full py-2 text-gray-500 hover:text-gray-700 text-sm">취소</button>
            </form>
        </div>
    </div>

    <!-- 상담 신청 완료 모달 -->
    <div id="consultationSuccessModal" class="modal-backdrop hidden" onclick="if(event.target === this) hideConsultationSuccessModal()">
        <div class="modal-content p-6 text-center">
            <div class="w-20 h-20 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">상담 신청이 완료되었습니다</h3>
            <p class="text-gray-500 mb-6">담당자가 곧 연락드리겠습니다.<br>카카오톡으로 알림이 전송되었습니다.</p>
            <button onclick="hideConsultationSuccessModal()" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition">확인</button>
        </div>
    </div>

    <script>
        // API Base URL - Railway 백엔드 URL
        const API_BASE_URL = window.ENV_API_URL || 'https://cgtcaculator-production.up.railway.app';

        let lastCalcResult = null;
        let currentTab = 'calc';
        let currentUser = null;
        let authToken = null;

        // 페이지 로드 시 로그인 상태 확인
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('[name="transfer_date"]').value = new Date().toISOString().split('T')[0];
            checkAuthStatus();
            handleKakaoCallback();
        });

        // 카카오 콜백 처리
        function handleKakaoCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                // URL에서 code 파라미터 제거
                window.history.replaceState({}, document.title, window.location.pathname);
                processKakaoLogin(code);
            }
        }

        async function processKakaoLogin(code) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/kakao/callback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateAuthUI();
                    if (data.user.needs_additional_info) {
                        showAdditionalInfoModal();
                    }
                } else {
                    alert('로그인에 실패했습니다.');
                }
            } catch (err) {
                console.error('카카오 로그인 오류:', err);
                alert('로그인 중 오류가 발생했습니다.');
            }
        }

        function checkAuthStatus() {
            try {
                authToken = localStorage.getItem('authToken');
                const userJson = localStorage.getItem('currentUser');
                if (authToken && userJson) {
                    currentUser = JSON.parse(userJson);
                    updateAuthUI();
                }
            } catch (e) {
                console.error('Auth check error:', e);
            }
        }

        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const userProfile = document.getElementById('userProfile');
            const userProfileImg = document.getElementById('userProfileImg');
            const userNickname = document.getElementById('userNickname');

            if (currentUser) {
                loginBtn.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userProfile.classList.add('flex');
                userNickname.textContent = currentUser.nickname || '사용자';
                if (currentUser.profile_image) {
                    userProfileImg.src = currentUser.profile_image;
                }
            } else {
                loginBtn.classList.remove('hidden');
                userProfile.classList.add('hidden');
            }
        }

        async function loginWithKakao() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/kakao/url`);
                const data = await res.json();
                if (data.auth_url) {
                    window.location.href = data.auth_url;
                } else {
                    alert('카카오 로그인 설정이 필요합니다.');
                }
            } catch (err) {
                alert('카카오 로그인 URL을 가져올 수 없습니다.');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            updateAuthUI();
        }

        function showLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
        function hideLoginModal() { document.getElementById('loginModal').classList.add('hidden'); }
        function showRegisterModal() { hideLoginModal(); document.getElementById('registerModal').classList.remove('hidden'); }
        function hideRegisterModal() { document.getElementById('registerModal').classList.add('hidden'); }
        function showLoginFromRegister() { hideRegisterModal(); showLoginModal(); }
        function showTermsModal() { document.getElementById('termsModal').classList.remove('hidden'); }
        function hideTermsModal() { document.getElementById('termsModal').classList.add('hidden'); }
        function showPrivacyModal() { document.getElementById('privacyModal').classList.remove('hidden'); }
        function hidePrivacyModal() { document.getElementById('privacyModal').classList.add('hidden'); }
        function showLoginRequiredModal() { document.getElementById('loginRequiredModal').classList.remove('hidden'); }
        function hideLoginRequiredModal() { document.getElementById('loginRequiredModal').classList.add('hidden'); }
        function showAdditionalInfoModal() { document.getElementById('additionalInfoModal').classList.remove('hidden'); }
        function hideAdditionalInfoModal() { document.getElementById('additionalInfoModal').classList.add('hidden'); }
        function hideConsultationModal() { document.getElementById('consultationModal').classList.add('hidden'); }
        function hideConsultationSuccessModal() { document.getElementById('consultationSuccessModal').classList.add('hidden'); }

        function toggleAllAgree() {
            const allChecked = document.getElementById('agreeAll').checked;
            document.getElementById('agreeTerms').checked = allChecked;
            document.getElementById('agreePrivacy').checked = allChecked;
        }

        // 로그인 후 실행할 대기 작업
        let pendingAction = null;
        let cachedFormData = null;

        function requireLogin(action, formData = null) {
            if (!currentUser) {
                pendingAction = action;
                cachedFormData = formData;
                showLoginRequiredModal();
                return false;
            }
            return true;
        }

        // 로그인 성공 후 대기 작업 실행
        function executePendingAction() {
            if (pendingAction === 'calculate' && cachedFormData) {
                submitCalculation(cachedFormData);
            } else if (pendingAction === 'consult' && cachedFormData) {
                submitConsultation(cachedFormData);
            }
            pendingAction = null;
            cachedFormData = null;
        }

        // 일반 로그인 폼 처리
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const phone = document.getElementById('loginPhone').value;

            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, phone })
                });
                const data = await res.json();
                if (res.ok && data.status === 'success') {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateAuthUI();
                    hideLoginModal();
                    hideLoginRequiredModal();
                    // 대기 작업이 있으면 실행
                    if (pendingAction) {
                        executePendingAction();
                    }
                } else {
                    alert(data.detail || '로그인에 실패했습니다.');
                }
            } catch (err) {
                alert('로그인 중 오류가 발생했습니다.');
            }
        });

        // 회원가입 폼 처리
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const name = document.getElementById('regName').value;
            const birthdate = document.getElementById('regBirthdate').value;
            const genderEl = document.querySelector('input[name="regGender"]:checked');
            const gender = genderEl ? genderEl.value : null;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const agreePrivacy = document.getElementById('agreePrivacy').checked;

            // 생년월일 형식 검증 (YYYY-MM-DD)
            if (birthdate) {
                const dateRegex = /^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/;
                if (!dateRegex.test(birthdate)) {
                    alert('생년월일 형식이 올바르지 않습니다.\n형식: YYYY-MM-DD (예: 1990-01-15)');
                    return;
                }
                const year = parseInt(birthdate.substring(0, 4));
                if (year < 1900 || year > 2024) {
                    alert('생년월일 연도는 1900~2024 사이여야 합니다.');
                    return;
                }
            }

            if (!agreeTerms || !agreePrivacy) {
                alert('필수 약관에 동의해 주세요.');
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email, phone, name, birthdate, gender,
                        agree_terms: agreeTerms,
                        agree_privacy: agreePrivacy
                    })
                });
                const data = await res.json();
                if (res.ok && data.status === 'success') {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    updateAuthUI();
                    hideRegisterModal();
                    hideLoginRequiredModal();
                    // 대기 작업이 있으면 실행
                    if (pendingAction) {
                        executePendingAction();
                    }
                } else {
                    alert(data.detail || '회원가입에 실패했습니다.');
                }
            } catch (err) {
                alert('회원가입 중 오류가 발생했습니다.');
            }
        });

        function showConsultationModal(type) {
            const modal = document.getElementById('consultationModal');
            const icon = document.getElementById('consultModalIcon');
            const title = document.getElementById('consultModalTitle');
            const submitBtn = document.getElementById('consultSubmitBtn');
            document.getElementById('consultationType').value = type;

            // 로그인 사용자 정보 자동 입력
            if (currentUser) {
                document.getElementById('consultName').value = currentUser.name || '';
                document.getElementById('consultPhone').value = currentUser.phone || '';
                document.getElementById('consultEmail').value = currentUser.email || '';
            }

            // 희망 상담일 기본값 설정 (내일)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('consultDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('consultDate').min = tomorrow.toISOString().split('T')[0];

            if (type === 'tax') {
                icon.className = 'w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center bg-gradient-to-r from-emerald-600 to-teal-600';
                title.textContent = '세무사 대면상담 신청';
                submitBtn.className = 'w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-semibold rounded-lg transition flex items-center justify-center space-x-2';
            } else {
                icon.className = 'w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center bg-gradient-to-r from-indigo-600 to-purple-600';
                title.textContent = '변호사 대면상담 신청';
                submitBtn.className = 'w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-lg transition flex items-center justify-center space-x-2';
            }
            modal.classList.remove('hidden');
        }

        // 대면상담 신청 폼 제출
        document.getElementById('consultationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('consultSubmitBtn');
            const submitText = document.getElementById('consultSubmitText');
            const submitSpinner = document.getElementById('consultSubmitSpinner');

            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            const data = {
                type: document.getElementById('consultationType').value,
                name: document.getElementById('consultName').value,
                phone: document.getElementById('consultPhone').value,
                email: document.getElementById('consultEmail').value,
                preferred_date: document.getElementById('consultDate').value,
                content: document.getElementById('consultContent').value
            };

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

                const res = await fetch(`${API_BASE_URL}/api/consultation/request`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.status === 'success') {
                    hideConsultationModal();
                    document.getElementById('consultationSuccessModal').classList.remove('hidden');
                    document.getElementById('consultationForm').reset();
                } else {
                    alert(result.message || '상담 신청에 실패했습니다.');
                }
            } catch (err) {
                alert('서버 연결 오류: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });

        document.getElementById('additionalInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('additionalName').value;
            const birthdate = document.getElementById('additionalBirthdate').value;
            const genderEl = document.querySelector('input[name="additionalGender"]:checked');
            const gender = genderEl ? genderEl.value : null;
            const email = document.getElementById('additionalEmail').value;
            const phone = document.getElementById('additionalPhone').value;

            if (!name || !birthdate || !gender || !phone) {
                alert('필수 항목을 모두 입력해 주세요.');
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/user/info`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ name, birthdate, gender, email, phone })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    currentUser.name = name;
                    currentUser.birthdate = birthdate;
                    currentUser.gender = gender;
                    currentUser.email = email;
                    currentUser.phone = phone;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    hideAdditionalInfoModal();
                    alert('정보가 저장되었습니다.');
                }
            } catch (err) {
                alert('정보 저장 중 오류가 발생했습니다.');
            }
        });

        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return new Intl.NumberFormat('ko-KR').format(num);
        }
        function formatMoney(num) { return formatNumber(num) + '원'; }
        function parseFormattedNumber(str) {
            if (!str) return 0;
            return parseInt(str.replace(/[^0-9]/g, '')) || 0;
        }
        function formatNumberInput(input) {
            const value = input.value.replace(/[^0-9]/g, '');
            if (value) input.value = formatNumber(parseInt(value));
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-calc').classList.toggle('hidden', tab !== 'calc');
            document.getElementById('tab-consult').classList.toggle('hidden', tab !== 'consult');
            document.getElementById('tab-meeting').classList.toggle('hidden', tab !== 'meeting');
            // Desktop buttons
            document.getElementById('btn-calc-desktop').classList.toggle('tab-active', tab === 'calc');
            document.getElementById('btn-calc-desktop').classList.toggle('text-blue-200', tab !== 'calc');
            document.getElementById('btn-consult-desktop').classList.toggle('tab-active', tab === 'consult');
            document.getElementById('btn-consult-desktop').classList.toggle('text-blue-200', tab !== 'consult');
            document.getElementById('btn-meeting-desktop').classList.toggle('tab-active', tab === 'meeting');
            document.getElementById('btn-meeting-desktop').classList.toggle('text-blue-200', tab !== 'meeting');
            // Mobile buttons
            document.getElementById('btn-calc-mobile').classList.toggle('text-blue-600', tab === 'calc');
            document.getElementById('btn-calc-mobile').classList.toggle('text-gray-400', tab !== 'calc');
            document.getElementById('btn-consult-mobile').classList.toggle('text-blue-600', tab === 'consult');
            document.getElementById('btn-consult-mobile').classList.toggle('text-gray-400', tab !== 'consult');
            document.getElementById('btn-meeting-mobile').classList.toggle('text-blue-600', tab === 'meeting');
            document.getElementById('btn-meeting-mobile').classList.toggle('text-gray-400', tab !== 'meeting');
        }

        function toggleAdvanced() {
            document.getElementById('advOptions').classList.toggle('hidden');
            document.getElementById('advIcon').classList.toggle('rotate-180');
        }

        document.getElementById('calcForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!requireLogin()) return;
            const form = e.target;
            const formData = new FormData(form);
            const btn = document.getElementById('calcBtn');
            const btnText = document.getElementById('calcBtnText');
            const btnSpinner = document.getElementById('calcBtnSpinner');
            btn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');

            const data = {
                transfer_date: formData.get('transfer_date'),
                acquisition_date: formData.get('acquisition_date'),
                transfer_price: parseFormattedNumber(formData.get('transfer_price')),
                acquisition_price: parseFormattedNumber(formData.get('acquisition_price')),
                necessary_expenses: parseFormattedNumber(formData.get('necessary_expenses')),
                asset_type: formData.get('asset_type'),
                is_1h1h: form.querySelector('[name="is_1h1h"]').checked,
                residence_years: parseInt(formData.get('residence_years')) || 0,
                is_adjusted_area: form.querySelector('[name="is_adjusted_area"]').checked,
                housing_count: parseInt(formData.get('housing_count')) || 1,
                reduction_type: formData.get('reduction_type'),
                is_registered: form.querySelector('[name="is_registered"]').checked
            };

            try {
                const res = await fetch(`${API_BASE_URL}/api/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                lastCalcResult = result;
                displayCalcResult(result);
            } catch (err) {
                alert('계산 중 오류가 발생했습니다: ' + err.message);
            } finally {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        });

        function displayCalcResult(result) {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('calcResult').classList.remove('hidden');
            document.getElementById('downloadPdfBtn').classList.remove('hidden');

            if (result.status === 'exempt' || result.status === 'no_tax') {
                document.getElementById('res_total').textContent = '0원';
                document.getElementById('res_rate_note').textContent = result.summary.message || '';
                document.getElementById('res_gross').textContent = formatMoney(result.calculation?.gross_gain || 0);
                document.getElementById('res_lthsd').textContent = '0원';
                document.getElementById('res_basic').textContent = '0원';
                document.getElementById('res_base').textContent = '0원';
                document.getElementById('res_calc').textContent = '0원';
                document.getElementById('res_reduction').textContent = '0원';
                document.getElementById('res_final').textContent = '0원';
                document.getElementById('res_local').textContent = '0원';
                document.getElementById('res_rural').textContent = '0원';
                document.getElementById('res_holding').textContent = result.calculation?.holding_period?.display || '-';
                document.getElementById('res_effective').textContent = '0%';
                return;
            }

            const s = result.summary;
            document.getElementById('res_total').textContent = formatMoney(s.total_tax);
            document.getElementById('res_rate_note').textContent = s.rate_note || '';
            document.getElementById('res_gross').textContent = formatMoney(s.gross_gain);
            document.getElementById('res_lthsd').textContent = '-' + formatMoney(s.lthsd_amount);
            document.getElementById('res_basic').textContent = '-' + formatMoney(result.calculation.basic_deduction);
            document.getElementById('res_base').textContent = formatMoney(s.tax_base);
            document.getElementById('res_calc').textContent = formatMoney(s.calc_tax);
            document.getElementById('res_reduction').textContent = '-' + formatMoney(s.reduction);
            document.getElementById('res_final').textContent = formatMoney(s.final_tax);
            document.getElementById('res_local').textContent = '+' + formatMoney(s.local_tax);
            document.getElementById('res_rural').textContent = '+' + formatMoney(s.rural_tax);
            document.getElementById('res_holding').textContent = s.holding_display;
            document.getElementById('res_effective').textContent = s.effective_rate + '%';

            const warningsContainer = document.getElementById('warningsContainer');
            const warningsList = document.getElementById('warningsList');
            if (result.warnings && result.warnings.length > 0) {
                warningsList.innerHTML = result.warnings.map(w => `<li>${w}</li>`).join('');
                warningsContainer.classList.remove('hidden');
            } else {
                warningsContainer.classList.add('hidden');
            }
        }

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!requireLogin()) return;
            const input = document.getElementById('userQuery');
            const query = input.value.trim();
            if (!query) return;

            const sendBtn = document.getElementById('sendBtn');
            const sendBtnText = document.getElementById('sendBtnText');
            const sendBtnSpinner = document.getElementById('sendBtnSpinner');
            sendBtn.disabled = true;
            sendBtnText.classList.add('hidden');
            sendBtnSpinner.classList.remove('hidden');

            addChatMessage(query, 'user');
            input.value = '';

            const loadingId = 'loading-' + Date.now();
            addChatMessage('보고서를 작성하고 있습니다...', 'assistant', loadingId, true);

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

                const res = await fetch(`${API_BASE_URL}/api/consult`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        query: query,
                        context_data: lastCalcResult ? lastCalcResult.summary : null
                    })
                });
                const result = await res.json();
                document.getElementById(loadingId)?.remove();

                if (result.status === 'success') {
                    addChatMessage('상담 보고서가 작성되었습니다.', 'assistant', null, false, true);
                    updateReportPreview(result.html);
                } else {
                    addChatMessage('죄송합니다. 오류가 발생했습니다.', 'assistant');
                }
            } catch (err) {
                document.getElementById(loadingId)?.remove();
                addChatMessage('서버 연결 실패: ' + err.message, 'assistant');
            } finally {
                sendBtn.disabled = false;
                sendBtnText.classList.remove('hidden');
                sendBtnSpinner.classList.add('hidden');
            }
        });

        function addChatMessage(content, role, id = null, isLoading = false, showReport = false) {
            const chatHistory = document.getElementById('chatHistory');
            const msgId = id || 'msg-' + Date.now();
            if (role === 'user') {
                chatHistory.innerHTML += `<div id="${msgId}" class="flex justify-end"><div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl rounded-tr-none px-4 py-3 max-w-[85%] shadow-sm"><p class="text-sm">${content}</p></div></div>`;
            } else {
                let extraHtml = showReport ? `<div class="mt-3"><button onclick="downloadReportPDF()" class="px-3 py-1.5 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700 transition">PDF 다운로드</button></div><div class="lg:hidden mt-4 border-t border-gray-100 pt-4" id="mobileReport"></div>` : '';
                chatHistory.innerHTML += `<div id="${msgId}" class="flex items-start space-x-3"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center flex-shrink-0"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div><div class="bg-white rounded-2xl rounded-tl-none px-4 py-3 shadow-sm max-w-[85%]">${isLoading ? '<div class="flex items-center space-x-2"><div class="spinner"></div><p class="text-sm text-gray-500">작성 중...</p></div>' : `<p class="text-sm text-gray-700">${content}</p>`}${extraHtml}</div></div>`;
            }
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function updateReportPreview(html) {
            document.getElementById('reportContent').innerHTML = `<div id="finalReport" class="bg-white p-6 rounded-xl shadow-sm">${html}</div>`;
            document.getElementById('reportPreview').classList.remove('hidden');
            document.getElementById('reportPreview').classList.add('lg:flex');
            const mobileReport = document.getElementById('mobileReport');
            if (mobileReport) mobileReport.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg text-sm">${html}</div>`;
        }

        function setQuickQuestion(question) {
            document.getElementById('userQuery').value = question;
            document.getElementById('userQuery').focus();
        }

        function goToConsultWithData() {
            switchTab('consult');
            if (lastCalcResult) {
                const s = lastCalcResult.summary;
                setQuickQuestion(`방금 계산한 양도세 결과를 검토해 주세요. 총 납부세액 ${formatMoney(s.total_tax)}, 양도차익 ${formatMoney(s.gross_gain)}, 실효세율 ${s.effective_rate}%입니다.`);
            }
        }

        function downloadCalcPDF() {
            const element = document.getElementById('printArea');
            if (!element) return;
            html2pdf().set({
                margin: 15,
                filename: `양도소득세_계산결과_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save();
        }

        function downloadReportPDF() {
            let element = document.getElementById('finalReport');
            if (!element) {
                const mobileReport = document.getElementById('mobileReport');
                if (mobileReport) element = mobileReport.querySelector('div');
            }
            if (!element) { alert('다운로드할 보고서가 없습니다.'); return; }
            html2pdf().set({
                margin: 15,
                filename: `세무상담_보고서_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save();
        }
    </script>
</body>
</html>
